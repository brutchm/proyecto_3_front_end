<div class="farm-page">
  <h1 class="farm-title">Mis Fincas</h1>
  <div class="farm-btn-group">
    <button class="farm-btn" (click)="fetchFarms()" [disabled]="loading">
      Recargar Fincas
    </button>
    <button class="farm-btn farm-btn-create" (click)="openCreateFarmModal()">
      Crear finca
    </button>
  </div>
  <ng-template #createFarmModal>
    <app-modal [hideFooter]="true" [useCustomBackGround]="true" modalBodyClass="modal-body dark-modal-body"
      modalContentClass="modal-content dark-modal-content create-farm-modal">
      <form [formGroup]="createFarmForm" (ngSubmit)="submitCreateFarm()" class="farm-create" novalidate
        autocomplete="off">
        <div class="modal-body mb-4 dark-modal-body">
          <h2 class="modal-title-text">Crear finca</h2>
          <div class="form-group mt-3">
            <label>Nombre de la finca</label>
            <input formControlName="farmName" class="form-control farm-input"
              [class.is-invalid]="createFarmSubmitted && createFarmForm.controls['farmName'].invalid" />
            <div *ngIf="createFarmSubmitted && createFarmForm.controls['farmName'].invalid" class="invalid-feedback">
              Este campo es requerido.</div>
          </div>
          <div class="form-group mt-3">
            <label>País</label>
            <input formControlName="farmCountry" class="form-control farm-input"
              [class.is-invalid]="createFarmSubmitted && createFarmForm.controls['farmCountry'].invalid" />
            <div *ngIf="createFarmSubmitted && createFarmForm.controls['farmCountry'].invalid" class="invalid-feedback">
              Este campo es requerido.</div>
          </div>
          <div class="form-group mt-3">
            <label>Provincia</label>
            <input formControlName="farmStateProvince" class="form-control farm-input"
              [class.is-invalid]="createFarmSubmitted && createFarmForm.controls['farmStateProvince'].invalid" />
            <div *ngIf="createFarmSubmitted && createFarmForm.controls['farmStateProvince'].invalid"
              class="invalid-feedback">Este campo es requerido.</div>
          </div>
          <div class="form-group mt-3">
            <label>Otras direcciones</label>
            <input formControlName="farmOtherDirections" class="form-control farm-input"
              [class.is-invalid]="createFarmSubmitted && createFarmForm.controls['farmOtherDirections'].invalid" />
            <div *ngIf="createFarmSubmitted && createFarmForm.controls['farmOtherDirections'].invalid"
              class="invalid-feedback">Este campo es requerido.</div>
          </div>
          <div class="form-group mt-3">
            <label>Ubicación (seleccione en el mapa)</label>
            <div class="d-flex align-items-center gap-2">
              <input formControlName="farmLocation" class="form-control farm-input" readonly
                [class.is-invalid]="createFarmSubmitted && createFarmForm.controls['farmLocation'].invalid" />
            </div>
            <div id="create-farm-map" class="location-map"></div>
            <div *ngIf="createFarmSubmitted && createFarmForm.controls['farmLocation'].invalid"
              class="invalid-feedback">Debe seleccionar una ubicación en el mapa.</div>
          </div>
          <div class="form-group mt-3">
            <label>Tamaño</label>
            <input formControlName="farmSize" class="form-control farm-input" type="number" min="0" step="0.01"
              [class.is-invalid]="createFarmSubmitted && createFarmForm.controls['farmSize'].invalid" />
            <div *ngIf="createFarmSubmitted && createFarmForm.controls['farmSize'].invalid" class="invalid-feedback">
              Ingrese un número válido.</div>
          </div>
          <div class="form-group mt-3 mb-3">
            <label>Unidad de medida</label>
            <input formControlName="farmMeasureUnit" class="form-control farm-input"
              [class.is-invalid]="createFarmSubmitted && createFarmForm.controls['farmMeasureUnit'].invalid" />
            <div *ngIf="createFarmSubmitted && createFarmForm.controls['farmMeasureUnit'].invalid"
              class="invalid-feedback">Este campo es requerido.</div>
          </div>
          <h3 class="mb-3">Información Técnica</h3>
          
        </div>
        <div class="modal-footer dark-modal-footer">
          <button type="button" class="btn btn-cancel farm-btn farm-btn-cancel"
            (click)="closeCreateFarmModal()">Cancelar</button>
          <button type="submit" class="btn btn-create farm-btn farm-btn-create"
            [disabled]="createFarmLoading">Crear</button>
        </div>
      </form>
    </app-modal>
  </ng-template>
  <div *ngIf="showCreateFarmModal">
    <div class="modal-backdrop"></div>
    <div class="centered-modal create-farm">
      <ng-container *ngTemplateOutlet="createFarmModal"></ng-container>
    </div>
  </div>
  <app-loader *ngIf="loading" class="mt-3"></app-loader>

  <div *ngIf="error" class="farm-error">
    {{ error }}
    <button *ngIf="error.includes('inicia sesión')" class="farm-btn farm-btn-secondary" (click)="goToLogin()">Ir a
      Login</button>
  </div>

  <div *ngIf="farms && !error" class="mt-4">
    <div *ngIf="farms?.length > 0; else noFarms" class="farm-cards-grid">
      <div *ngFor="let item of farms; let i = index" class="farm-card">
        <h2 class="farm-card-title">{{ item.farm.farmName }}</h2>
        <div class="pt-3 pb-4 px-4 pr-4">
          <div id="farm-map-{{i}}" class="farm-map mb-4"></div>
          <p class="farm-card-text"><strong>País:</strong> {{ item.farm.farmCountry }}</p>
          <p class="farm-card-text"><strong>Provincia:</strong> {{ item.farm.farmStateProvince }}</p>
          <p class="farm-card-text"><strong>Ubicación:</strong> {{ item.farm.farmLocation }}</p>
          <p class="farm-card-text"><strong>Tamaño:</strong> {{ item.farm.farmSize }} {{ item.farm.farmMeasureUnit }}
          </p>
          <p class="farm-card-text"><strong>Direcciones:</strong> {{ item.farm.farmOtherDirections }}</p>
          <a class="farm-details-link" (click)="goToFarmDetails(item.farm.id)">Ver detalles</a>
        </div>

      </div>
    </div>
    <ng-template #noFarms>
      <p class="farm-no-farms">No tienes fincas registradas.</p>
    </ng-template>
  </div>
</div>